<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="tmfast">
<title>Fitting topic models (and simulating text data) with `tmfast` • tmfast</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Fitting topic models (and simulating text data) with `tmfast`">
<meta property="og:description" content="tmfast">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">tmfast</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.2023-04-15</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/realbooks.html">Fast topic modeling with real books</a>
    <a class="dropdown-item" href="../articles/simulated.html">Fitting topic models (and simulating text data) with `tmfast`</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Fitting topic models (and simulating text data) with `tmfast`</h1>
                        <h4 data-toc-skip class="author"></h4>
<p>Dan Hicks <a href="mailto:hicks.daniel.j@gmail.com" class="email">hicks.daniel.j@gmail.com</a></p>
            
      
      
      <div class="d-none name"><code>simulated.Rmd</code></div>
    </div>

    
    
<p>In this vignette, we demonstrate a basic workflow using
<code>tmfast</code>to fit topic models. We also show how the generators
included in the package can be used to create simulated text data. The
vignette assumes you’re already familiar with topic models, and
specifically the latent dirichlet allocation (LDA) data generation
model, along with PCA and varimax. The <code>tmfast</code> package was
inspired by <span class="citation">@RoheVintageFactorAnalysis2020</span>, who provide the
mathematical justification for treating topic modeling as
varimax-rotated PCA, but somewhat finicky and incomplete software for
actually fitting models using this approach.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## ── <span style="font-weight: bold;">Attaching core tidyverse packages</span> ──────────────────────── tidyverse 2.0.0 ──</span></span>
<span><span class="co">## <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">dplyr    </span> 1.1.2     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">readr    </span> 2.1.4</span></span>
<span><span class="co">## <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">forcats  </span> 1.0.0     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">stringr  </span> 1.5.0</span></span>
<span><span class="co">## <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">ggplot2  </span> 3.4.2     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">tibble   </span> 3.2.1</span></span>
<span><span class="co">## <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">lubridate</span> 1.9.2     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">tidyr    </span> 1.3.0</span></span>
<span><span class="co">## <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">purrr    </span> 1.0.2     </span></span>
<span><span class="co">## ── <span style="font-weight: bold;">Conflicts</span> ────────────────────────────────────────── tidyverse_conflicts() ──</span></span>
<span><span class="co">## <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">dplyr</span>::<span style="color: #00BB00;">filter()</span> masks <span style="color: #0000BB;">stats</span>::filter()</span></span>
<span><span class="co">## <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">dplyr</span>::<span style="color: #00BB00;">lag()</span>    masks <span style="color: #0000BB;">stats</span>::lag()</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Use the conflicted package (<span style="color: #0000BB; font-style: italic;">&lt;http://conflicted.r-lib.org/&gt;</span>) to force all conflicts to become errors</span></span></code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/gaborcsardi/lpSolve" class="external-link">lpSolve</a></span><span class="op">)</span>    <span class="co"># For matching fitted and trust topics</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jabiru/tictoc" class="external-link">tictoc</a></span><span class="op">)</span>     <span class="co"># For checking timing</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dhicks.github.io/tmfast/">tmfast</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Attaching package: 'tmfast'</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## The following object is masked from 'package:stats':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     loadings</span></span></code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.structuraltopicmodel.com/" class="external-link">stm</a></span><span class="op">)</span>        <span class="co"># Used for comparison</span></span></code></pre></div>
<pre><code><span><span class="co">## stm v1.3.6.1 successfully loaded. See ?stm for help. </span></span>
<span><span class="co">##  Papers, resources, and other materials at structuraltopicmodel.com</span></span></code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/juliasilge/tidytext" class="external-link">tidytext</a></span><span class="op">)</span>   <span class="co"># Used for stm tidiers</span></span></code></pre></div>
<div class="section level2">
<h2 id="simulated-text-data">Simulated text data<a class="anchor" aria-label="anchor" href="#simulated-text-data"></a>
</h2>
<div class="section level3">
<h3 id="simulation-parameters">Simulation parameters<a class="anchor" aria-label="anchor" href="#simulation-parameters"></a>
</h3>
<p>We create simulated text data following the data-generating process
assumed by LDA. Specifically, each document will be generated from one
of several “journals.” Each journal corresponds to a topic, and vice
versa, in that documents from journal <span class="math inline">\(j\)</span> will tend to have a much greater
mixture (probably) of topic <span class="math inline">\(j\)</span> than
the other topics.</p>
<p>We first specify the number of topics/journals <code>k</code>, and
the number of documents to draw from each journal <code>Mj</code>, for a
total of <code>M = Mj * k</code> documents in the corpus. We also
specify the length of the vocabulary (total unique words) as a multiple
of the total number of documents <code>M</code>. Document lengths are
generated using a negative binomial distribution, using the size-mean
parameterization. Per <code><a href="https://rdrr.io/r/stats/NegBinomial.html" class="external-link">?NegBinomial</a></code>, the standard deviation
of document lengths in this parameterization is <span class="math inline">\(\sqrt{\mu +
\frac{\mu^2}{\mathrm{size}}}\)</span></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">k</span> <span class="op">=</span> <span class="fl">10</span>                <span class="co"># Num. topics / journals</span></span>
<span><span class="va">Mj</span> <span class="op">=</span> <span class="fl">100</span>              <span class="co"># Num. documents per journal</span></span>
<span><span class="va">M</span> <span class="op">=</span> <span class="va">Mj</span><span class="op">*</span><span class="va">k</span>              <span class="co"># Total corpus size</span></span>
<span><span class="va">vocab</span> <span class="op">=</span> <span class="va">M</span>             <span class="co"># Vocabulary length</span></span>
<span></span>
<span><span class="co">## Negative binomial distribution of doc lengths</span></span>
<span><span class="va">size</span> <span class="op">=</span> <span class="fl">10</span>             <span class="co"># Size and mean</span></span>
<span><span class="va">mu</span> <span class="op">=</span> <span class="fl">300</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">mu</span> <span class="op">+</span> <span class="va">mu</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span><span class="va">size</span><span class="op">)</span>  <span class="co"># Resulting SD of document sizes</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 96.43651</span></span></code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Dirichlet distributions for topic-docs and word-topics</span></span>
<span><span class="va">topic_peak</span> <span class="op">=</span> <span class="fl">.8</span></span>
<span><span class="va">topic_scale</span> <span class="op">=</span> <span class="fl">10</span></span>
<span></span>
<span><span class="va">word_beta</span> <span class="op">=</span> <span class="fl">0.1</span></span></code></pre></div>
<p>Because the simulations involve drawing samples using a RNG, we first
set a seed.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2022</span><span class="op">-</span><span class="fl">06</span><span class="op">-</span><span class="fl">19</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="draw-true-topic-distributions">Draw true topic distributions<a class="anchor" aria-label="anchor" href="#draw-true-topic-distributions"></a>
</h3>
<p>We first generate the true topic-document distributions <span class="math inline">\(p(\theta = t | \mathrm{doc}_m)\)</span>, often
simply called <span class="math inline">\(\theta\)</span> or <span class="math inline">\(\gamma\)</span>. In this vignette we use <span class="math inline">\(\theta\)</span> for the true distribution and
<span class="math inline">\(\gamma\)</span> for the fitted distribution
in the topic model. Each document’s <span class="math inline">\(\theta\)</span> is sampled from a Dirichlet
distribution (<code><a href="../reference/rdirichlet.html">rdirichlet()</a></code>), with the parameter <span class="math inline">\(\mathbf{\alpha}\)</span> corresponding to the
document’s journal <span class="math inline">\(j\)</span>. The variable
<code>theta</code> is a <code>M</code> by <code>k</code> matrix;
<code>theta_df</code> is a tidy representation with columns
<code>doc</code>, <code>topic</code>, and <code>prob</code>. The
visualization confirms that documents are generally most strongly
associated with the corresponding topics, though with some noise.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Journal-specific alpha, with a peak value (.8 by default) and uniform otherwise</span></span>
<span><span class="va">theta</span> <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">k</span>, </span>
<span>            <span class="op">~</span><span class="fu"><a href="../reference/rdirichlet.html">rdirichlet</a></span><span class="op">(</span><span class="va">Mj</span>, <span class="fu"><a href="../reference/peak_alpha.html">peak_alpha</a></span><span class="op">(</span><span class="va">k</span>, <span class="va">.x</span>, </span>
<span>                                       peak <span class="op">=</span> <span class="va">topic_peak</span>, </span>
<span>                                       scale <span class="op">=</span> <span class="va">topic_scale</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/reduce.html" class="external-link">reduce</a></span><span class="op">(</span><span class="va">rbind</span><span class="op">)</span></span>
<span></span>
<span><span class="va">theta_df</span> <span class="op">=</span> <span class="va">theta</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">'doc'</span>, </span>
<span>              .name_repair <span class="op">=</span> <span class="fu">tmfast</span><span class="fu">:::</span><span class="va"><a href="../reference/make_colnames.html">make_colnames</a></span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>doc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">doc</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">'V'</span><span class="op">)</span>,</span>
<span>                 names_to <span class="op">=</span> <span class="st">'topic'</span>,</span>
<span>                 values_to <span class="op">=</span> <span class="st">'prob'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">theta_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">doc</span>, <span class="va">topic</span>, fill <span class="op">=</span> <span class="va">prob</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulated_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="draw-true-word-distributions">Draw true word distributions<a class="anchor" aria-label="anchor" href="#draw-true-word-distributions"></a>
</h3>
<p>Next we generate the true word-topic distributions <span class="math inline">\(p(\phi = w | \theta = t)\)</span>, often designed
as either <span class="math inline">\(\phi\)</span> or <span class="math inline">\(\beta\)</span>. We use <span class="math inline">\(\phi\)</span> for the true distribution and <span class="math inline">\(\beta\)</span> for the fitted distribution. We
sample these distributions from a symmetric Dirichlet distribution over
the length of the vocabulary with <span class="math inline">\(\alpha =
.01\)</span>. Tile and Zipfian (probability vs. rank on a log-log scale)
plots confirm these distributions are working correctly.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## phi_j:  Word distribution for topic j</span></span>
<span><span class="va">phi</span> <span class="op">=</span> <span class="fu"><a href="../reference/rdirichlet.html">rdirichlet</a></span><span class="op">(</span><span class="va">k</span>, <span class="va">word_beta</span>, k <span class="op">=</span> <span class="va">vocab</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Word distributions</span></span>
<span><span class="va">phi</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">'topic'</span>, </span>
<span>              .name_repair <span class="op">=</span> <span class="fu">tmfast</span><span class="fu">:::</span><span class="va"><a href="../reference/make_colnames.html">make_colnames</a></span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">'V'</span><span class="op">)</span>,</span>
<span>                 names_to <span class="op">=</span> <span class="st">'word'</span>,</span>
<span>                 values_to <span class="op">=</span> <span class="st">'prob'</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">topic</span>, <span class="va">word</span>, fill <span class="op">=</span> <span class="op">(</span><span class="va">prob</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html" class="external-link">scale_y_discrete</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulated_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Zipf's law</span></span>
<span><span class="va">phi</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">'topic'</span>, </span>
<span>              .name_repair <span class="op">=</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html" class="external-link">str_c</a></span><span class="op">(</span><span class="st">'word'</span>, <span class="fl">1</span><span class="op">:</span><span class="va">vocab</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">'word'</span><span class="op">)</span>,</span>
<span>                 names_to <span class="op">=</span> <span class="st">'word'</span>,</span>
<span>                 values_to <span class="op">=</span> <span class="st">'prob'</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">topic</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>rank <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rank.html" class="external-link">rank</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">desc</a></span><span class="op">(</span><span class="va">prob</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">topic</span>, <span class="va">rank</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">rank</span> <span class="op">&lt;</span> <span class="va">vocab</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">rank</span>, <span class="va">prob</span>, color <span class="op">=</span> <span class="va">topic</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_log10</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulated_files/figure-html/unnamed-chunk-5-2.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="document-lengths">Document lengths<a class="anchor" aria-label="anchor" href="#document-lengths"></a>
</h3>
<p>Again, document lengths are drawn from a negative binomial
distribution.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## N_i:  Length of document i</span></span>
<span><span class="va">N</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/NegBinomial.html" class="external-link">rnbinom</a></span><span class="op">(</span><span class="va">M</span>, size <span class="op">=</span> <span class="va">size</span>, mu <span class="op">=</span> <span class="va">mu</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">##    93.0   240.8   300.5   308.6   364.5   774.0</span></span></code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 95.1555</span></span></code></pre>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulated_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="draw-corpus">Draw corpus<a class="anchor" aria-label="anchor" href="#draw-corpus"></a>
</h3>
<p>Finally we draw the corpus, the observed word counts for each
document. This is the most time-consuming step in this script, much
slower than actually fitting the topic model. Experimenting with this
simulation, we found that <code><a href="https://rdrr.io/r/base/Log.html" class="external-link">log1p()</a></code> scaling of the word
counts produced better results than other scaling techniques (eg,
dividing by the total length of each document, scaling words by their
standard deviation) for accounting for radical differences in document
length.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html" class="external-link">tic</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">corpus</span> <span class="op">=</span> <span class="fu"><a href="../reference/draw_corpus.html">draw_corpus</a></span><span class="op">(</span><span class="va">N</span>, <span class="va">theta</span>, <span class="va">phi</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html" class="external-link">toc</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 27.636 sec elapsed</span></span></code></pre>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dtm</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">corpus</span>, n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log1p</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="fit-the-topic-model">Fit the topic model<a class="anchor" aria-label="anchor" href="#fit-the-topic-model"></a>
</h2>
<p>Fitting the topic model is extremely fast. Note that we can request
multiple numbers of topics in a single call. Under the hood, we first
cast the document-term matrix (which is already in a sparse
representation) to a sparse matrix. Then we extract the maximum number
of desired principal components using
<code><a href="https://rdrr.io/pkg/irlba/man/prcomp_irlba.html" class="external-link">irlba::prcomp_irlba()</a></code>, centering but not scaling the logged
word counts. (Experiments with this simulation indicated that scaling
makes it more difficult to construct probability distributions later.)
<code>irlba</code> implements <a href="https://cran.r-project.org/web/packages/irlba/vignettes/irlba.pdf" class="external-link">an
extremely efficient algorithm</a> for partial singular value
decompositions of large sparse matrices. Next we use
<code>stats:varimax()</code> to construct a preliminary varimax rotation
of the principal components. Because the direction of factors is
arbitrary as far as varimax is concerned, but meaningful when we convert
things to probability distributions, we check the skew of each factor’s
loadings in the preliminary fit, and reverse the factors with negative
skew (long left tails).<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Varimax is more often associated with factor analysis
than PCA, because &lt;a href="https://stats.stackexchange.com/questions/577632/why-arent-varimax-rotated-loadings-orthogonal" class="external-link"&gt;varimax-rotated
basis vectors are no longer orthogonal&lt;/a&gt;. Unlike PCA, in topic
modeling we don’t care about orthogonality. And unlike factor analysis,
we’re not interested in dropping features (words) that don’t load
substantially on exactly one factor (topic).&lt;/p&gt;'><sup>1</sup></a></p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html" class="external-link">tic</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">fitted</span> <span class="op">=</span> <span class="fu"><a href="../reference/tmfast.html">tmfast</a></span><span class="op">(</span><span class="va">dtm</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span>, <span class="va">k</span>, <span class="fl">2</span><span class="op">*</span><span class="va">k</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html" class="external-link">toc</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 0.767 sec elapsed</span></span></code></pre>
<p>The object returned by <code><a href="../reference/tmfast.html">tmfast()</a></code> has a simple structure.
<code>totalvar</code> and <code>sdev</code> come from the PCA step,
giving the total variance across all feature variables and the standard
deviation of each extracted principal component. (Note that these PCs do
not generally correspond to the varimax-rotated factors/topics.)
<code>n</code> contains the sizes (number of factors/topics) fitted for
the models, and <code>varimaxes</code> contains the varimax fit for each
value of <code>n</code>. The varimax objects each contain three
matrices, the rotated <code>loadings</code> (word-topics), the rotation
matrix <code>rotmat</code>, and the rotated <code>scores</code>
(document-topics).</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">fitted</span>, max.level <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## List of 9</span></span>
<span><span class="co">##  $ totalvar: num 138</span></span>
<span><span class="co">##  $ sdev    : num [1:20] 3.26 3.06 3.01 2.97 2.93 ...</span></span>
<span><span class="co">##  $ rows    : chr [1:1000] "1" "2" "3" "4" ...</span></span>
<span><span class="co">##  $ cols    : chr [1:999] "5" "7" "8" "11" ...</span></span>
<span><span class="co">##  $ center  : Named num [1:999] 0.4016 0.0943 0.4254 0.2396 0.4093 ...</span></span>
<span><span class="co">##   ..- attr(*, "names")= chr [1:999] "5" "7" "8" "11" ...</span></span>
<span><span class="co">##  $ scale   : logi FALSE</span></span>
<span><span class="co">##  $ rotation: num [1:999, 1:20] -0.00112 0.02725 0.01223 0.00457 -0.00883 ...</span></span>
<span><span class="co">##   ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">##  $ n       : num [1:4] 2 3 10 20</span></span>
<span><span class="co">##  $ varimax :List of 4</span></span>
<span><span class="co">##   ..$ 2 :List of 3</span></span>
<span><span class="co">##   ..$ 3 :List of 3</span></span>
<span><span class="co">##   ..$ 10:List of 3</span></span>
<span><span class="co">##   ..$ 20:List of 3</span></span>
<span><span class="co">##  - attr(*, "class")= chr [1:3] "tmfast" "varimaxes" "list"</span></span></code></pre>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">fitted</span><span class="op">$</span><span class="va">varimax</span><span class="op">$</span><span class="va">`5`</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  NULL</span></span></code></pre>
<p>Because the model contains a <code>sdev</code> component,
<code><a href="https://rdrr.io/r/stats/screeplot.html" class="external-link">screeplot()</a></code> works out of the box. Note that the first <span class="math inline">\(k\)</span> PCs have much higher variance than the
others, and often the <span class="math inline">\(k\)</span>th PC is
somewhat lower than the first <span class="math inline">\(k-1\)</span>.
This reflects the highly simplified structure of the simulated data.
Real datasets often have a much more gradual decline in the screeplot,
likely reflecting the complex hierarchy of topics in actual
documents.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/screeplot.html" class="external-link">screeplot</a></span><span class="op">(</span><span class="va">fitted</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulated_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<p>It’s also straightforward to calculate the share of total variance
covered by successive principal components. Experimenting with this
simulation, when some documents are much larger than others, <span class="math inline">\(k\)</span> PCs might cover less than half of the
total variance. In this case it covers about 65%. Again, note that the
rotated varimax factors don’t correspond to the principal components;
but the total covered variance remains the same.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Variance coverage?</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">fitted</span><span class="op">$</span><span class="va">sdev</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="va">fitted</span><span class="op">$</span><span class="va">totalvar</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] 0.07689789 0.14466433 0.21018176 0.27420309 0.33636478 0.39492291</span></span>
<span><span class="co">##  [7] 0.45196354 0.50563725 0.55705654 0.57380104 0.57606900 0.57828256</span></span>
<span><span class="co">## [13] 0.58048004 0.58264465 0.58479395 0.58691426 0.58902127 0.59107016</span></span>
<span><span class="co">## [19] 0.59311409 0.59514063</span></span></code></pre>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>PC <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">fitted</span><span class="op">$</span><span class="va">sdev</span><span class="op">)</span>,</span>
<span>           cum_var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">fitted</span><span class="op">$</span><span class="va">sdev</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="va">fitted</span><span class="op">$</span><span class="va">totalvar</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">PC</span>, <span class="va">cum_var</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulated_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="fitting-a-conventional-topic-model-stm">Fitting a conventional topic model (stm)<a class="anchor" aria-label="anchor" href="#fitting-a-conventional-topic-model-stm"></a>
</h2>
<p>For comparison, we’ll also fit a conventional topic model using the
<code>stm</code> package. To address the challenge of picking a number
of topics, it will conduct a topic estimation process when passed
<code>K = 0</code>. With the simulation parameters and the random seed
used here, this process takes almost 12 seconds and produces a model
with 33 topics. We therefore do not automatically run the next
chunk.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html" class="external-link">tic</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">corpus</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tidytext/man/cast_sparse.html" class="external-link">cast_sparse</a></span><span class="op">(</span><span class="va">doc</span>, <span class="va">word</span>, <span class="va">n</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/stm/man/stm.html" class="external-link">stm</a></span><span class="op">(</span>K <span class="op">=</span> <span class="fl">0</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html" class="external-link">toc</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Setting <code>K = k</code> gives us a fitted topic model in a few
seconds, about an order of magnitude slower than
<code><a href="../reference/tmfast.html">tmfast()</a></code>.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html" class="external-link">tic</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">fitted_stm</span> <span class="op">=</span> <span class="va">corpus</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tidytext/man/cast_sparse.html" class="external-link">cast_sparse</a></span><span class="op">(</span><span class="va">doc</span>, <span class="va">word</span>, <span class="va">n</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/stm/man/stm.html" class="external-link">stm</a></span><span class="op">(</span>K <span class="op">=</span> <span class="va">k</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html" class="external-link">toc</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 4.67 sec elapsed</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="assessing-accuracy">Assessing accuracy<a class="anchor" aria-label="anchor" href="#assessing-accuracy"></a>
</h2>
<p>Using simulated data with true word-topic and topic-document
distributions lets us check the accuracy of varimax-based topic models.
Here we’ll develop a method proposed by Malaterre and Lareau (2022),
comparing distributions using Hellinger distance. For discrete
probability distributions <span class="math inline">\(p, q\)</span> over
the same space <span class="math inline">\(X\)</span>, the Hellinger
distance is given by <span class="math display">\[ d(p,q) =
\frac{1}{\sqrt{2}} \sqrt{\sum_{x \in X} (\sqrt{p(x)} - \sqrt{q(x)})^2} =
\frac{1}{\sqrt{2}} \lVert \sqrt p - \sqrt q \rVert_2.\]</span> The last
equation means that the Hellinger distance is the Euclidean (<span class="math inline">\(L^2\)</span>-norm) distance between the <em>square
roots</em> of the distributions. Some authors working with topic models
sometimes compare distributions using the <span class="math inline">\(L^2\)</span>-norm of the distributions themselves,
without the square root. But this approach is flawed, since probability
distributions can have different lengths in the <span class="math inline">\(L^2\)</span> norm. (For example, the distribution
<span class="math inline">\(\left&lt; 1, 0\right&gt;\)</span> has <span class="math inline">\(L^2\)</span> length 1, while <span class="math inline">\(\left&lt; \frac{1}{2}, \frac{1}{2}
\right&gt;\)</span> has <span class="math inline">\(L^2\)</span> length
approximately 1.19.)<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Cosine similarity is directly related to the &lt;span class="math inline"&gt;\(L^2\)&lt;/span&gt;-norm, and has the same problem.&lt;/p&gt;'><sup>2</sup></a></p>
<p>Hellinger distance satisfies the equation <span class="math display">\[ 1 - d^2(p, q) = \sum_{x \in X} \sqrt{p(x)q(x)}.
\]</span> When working with topic models, we’re interested in pairwise
sets of Hellinger distances, either between all pairs of distributions
from a single set (for example, the topic distributions for each
document, as used in “discursive space” analysis <em>[cite and
xref]</em>) or two sets (for example, comparing fitted vs. true
word-topic distributions, as in this section). Working with two sets of
distributions <span class="math inline">\(P = \{p_i | i \in I\}\)</span>
and <span class="math inline">\(Q = \{q_j | j \in J\}\)</span>, the
right-hand side of the last equation is equivalent to a matrix
multiplication.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;For &lt;span class="math inline"&gt;\(P\)&lt;/span&gt;, each row
corresponds to the elementwise square root of one distribution &lt;span class="math inline"&gt;\(\sqrt p_i\)&lt;/span&gt; and each column to one
component &lt;span class="math inline"&gt;\(x \in X\)&lt;/span&gt;, i.e., a cell
contains the value &lt;span class="math inline"&gt;\(\sqrt{p_i(x)}\)&lt;/span&gt;.
&lt;span class="math inline"&gt;\(Q\)&lt;/span&gt; is the transpose, with each row
corresponding to one component &lt;span class="math inline"&gt;\(x \in
X\)&lt;/span&gt; and each column corresponding to the square root of a
distribution &lt;span class="math inline"&gt;\(\sqrt q_j\)&lt;/span&gt;. The product
of these matrices is a &lt;span class="math inline"&gt;\(i \times j\)&lt;/span&gt;
matrix with each cell the desired sum for &lt;span class="math inline"&gt;\(p\)&lt;/span&gt; and &lt;span class="math inline"&gt;\(q\)&lt;/span&gt;.&lt;/p&gt;'><sup>3</sup></a> The <code><a href="../reference/hellinger.html">hellinger()</a></code> function
provides S3 methods for calculating Hellinger pairwise distances given a
single dataframe, single matrix, or two dataframes or matrices.</p>
<p>First, however, we need to extract the word-topic distributions.
<code>tmfast</code> provides a <code><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy()</a></code> method, following the
pattern of the topicmodel tidiers in <code>tidytext</code>. Unlike other
topic models, <code>tmfast</code> objects can contain models for
multiple different values of <span class="math inline">\(k\)</span>
(numbers of topics). So, in the second argument to <code><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy()</a></code>,
we need to specify which number of topics we want. The third argument
specifies the desired set of distributions, either word-topics
(<code>'beta'</code>) or topic-documents (<code>'gamma'</code>).</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## beta: fitted varimax loadings, transformed to probability distributions</span></span>
<span><span class="va">beta</span> <span class="op">=</span> <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">fitted</span>, <span class="va">k</span>, <span class="st">'beta'</span><span class="op">)</span></span></code></pre></div>
<p>Word-topic distributions correspond to the varimax factor loadings.
These loadings can take any real value. To convert them to probability
distributions, within each factor (topic), we trim negative values to 0
and divide each loading by the sum of all loadings. The Zipfian plot
below compares the fitted and true word-topic distributions.
Consistently across experiments with this simulation, fitted
distributions started off a little flatter, then dropped sharply after
about 100 words. In other words, the varimax topic model highlights a
relatively long list of characteristic words for each topic — the actual
distributions have fewer characteristic words — and then ignores the
other words.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Compare Zipfian distributions</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">{</span><span class="va">beta</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">'fitted'</span><span class="op">)</span><span class="op">}</span>,</span>
<span>        <span class="op">{</span><span class="va">phi</span> <span class="op">|&gt;</span></span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>                <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">'token'</span>, </span>
<span>                          .name_repair <span class="op">=</span> <span class="fu">tmfast</span><span class="fu">:::</span><span class="va"><a href="../reference/make_colnames.html">make_colnames</a></span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>                <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">'V'</span><span class="op">)</span>,</span>
<span>                             names_to <span class="op">=</span> <span class="st">'topic'</span>,</span>
<span>                             values_to <span class="op">=</span> <span class="st">'beta'</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>                <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>beta_rn <span class="op">=</span> <span class="va">beta</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>                <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">'true'</span><span class="op">)</span><span class="op">}</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">type</span>, <span class="va">topic</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>rank <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rank.html" class="external-link">rank</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">desc</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">type</span>, <span class="va">topic</span>, <span class="va">rank</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">rank</span> <span class="op">&lt;</span> <span class="va">vocab</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">rank</span>, <span class="va">beta</span>, color <span class="op">=</span> <span class="va">type</span>, </span>
<span>               group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/interaction.html" class="external-link">interaction</a></span><span class="op">(</span><span class="va">topic</span>, <span class="va">type</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_log10</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulated_files/figure-html/unnamed-chunk-15-1.png" width="700">
The Zipfian distribution doesn’t tell us which fitted topics might
correspond to which true topics. For that, following Malaterre and
Lareau, we’ll use pairwise Hellinger distances. There’s one
complication, however. The parameters chosen for this simulation
typically end up not drawing some of the words from the vocabulary, and
they don’t end up in the same order as the true word-topic matrix
<code>phi</code>. Fortunately words are represented as the integers
<code>1:vocab</code>, so it’s relatively painless to put them back in
order and fill in the gaps (setting the probability for the missing
words to be 0 across all topics). In the pipe below, we first fix these
issues with the words, widen the long dataframe, convert it to a matrix,
and then calculate pairwise Hellinger distances with the true word-topic
matrix <code>phi</code>.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Hellinger distance of word-topic distributions</span></span>
<span><span class="va">beta_mx</span> <span class="op">=</span> <span class="va">beta</span> <span class="op">|&gt;</span></span>
<span>    <span class="co">## Fix order of words</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>token <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">token</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">token</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="co">## And dropped words</span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/complete.html" class="external-link">complete</a></span><span class="op">(</span>token <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">vocab</span>, <span class="va">topic</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="st">'topic'</span>,</span>
<span>                values_from <span class="op">=</span> <span class="st">'beta'</span>, values_fill <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                names_sort <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="co"># select(-`NA`) |&gt;</span></span>
<span>    <span class="co">## Coerce to matrix</span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html" class="external-link">column_to_rownames</a></span><span class="op">(</span><span class="st">'token'</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/hellinger.html">hellinger</a></span><span class="op">(</span><span class="va">phi</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">beta_mx</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##             V01       V02       V03       V04       V05       V06       V07</span></span>
<span><span class="co">##  [1,] 0.9031738 0.1637336 0.9165058 0.9123347 0.8751537 0.8995845 0.9036184</span></span>
<span><span class="co">##  [2,] 0.9059649 0.8784121 0.9101200 0.8988053 0.1568935 0.9154690 0.8912032</span></span>
<span><span class="co">##  [3,] 0.9109254 0.8784830 0.9078316 0.8766395 0.8950844 0.8955629 0.8863298</span></span>
<span><span class="co">##  [4,] 0.9364565 0.9175881 0.1665250 0.9072348 0.9071975 0.8779525 0.9121768</span></span>
<span><span class="co">##  [5,] 0.8953244 0.9050252 0.9027020 0.8977285 0.8866189 0.9016970 0.1828639</span></span>
<span><span class="co">##  [6,] 0.9229747 0.9117772 0.8779031 0.8931918 0.9100060 0.1807501 0.9014234</span></span>
<span><span class="co">##  [7,] 0.1642187 0.9068759 0.9378145 0.8921973 0.9020294 0.9310713 0.8995111</span></span>
<span><span class="co">##  [8,] 0.9146167 0.8876726 0.9160216 0.8977089 0.9003917 0.9068250 0.8869320</span></span>
<span><span class="co">##  [9,] 0.8956926 0.9145803 0.9014559 0.1682888 0.8991201 0.9032983 0.8980827</span></span>
<span><span class="co">## [10,] 0.9112636 0.9152296 0.9052323 0.8935218 0.9000401 0.8869707 0.8837047</span></span>
<span><span class="co">##             V08       V09       V10</span></span>
<span><span class="co">##  [1,] 0.9223213 0.8852931 0.8929746</span></span>
<span><span class="co">##  [2,] 0.9044976 0.8865806 0.9026687</span></span>
<span><span class="co">##  [3,] 0.9139487 0.1770633 0.9222647</span></span>
<span><span class="co">##  [4,] 0.9077645 0.9109467 0.9142646</span></span>
<span><span class="co">##  [5,] 0.8797781 0.8815338 0.8907767</span></span>
<span><span class="co">##  [6,] 0.8961334 0.8931672 0.9064453</span></span>
<span><span class="co">##  [7,] 0.9032734 0.9106445 0.9160885</span></span>
<span><span class="co">##  [8,] 0.8796820 0.9247945 0.1708753</span></span>
<span><span class="co">##  [9,] 0.8968698 0.8872700 0.9004598</span></span>
<span><span class="co">## [10,] 0.1616073 0.9255980 0.8824513</span></span></code></pre>
<p>In this distance matrix, the rows are the true topics and the columns
are the fitted topics. Low values include that the topics are closer to
each other. It’s clear that the topics don’t match up perfectly —
typically the minimum in each row is about 0.17 — but there is a clear
minimum. We treat this as a linear assignment problem, which is solved
rapidly using the <code>lpSolve</code> package. The solution — which
matches true to fitted topics — can then be used as a rotation with both
the loadings and scores (topic-document distributions). After rotating,
the true-fitted pairs are on the diagonal of the Hellinger distance
matrix, making it easy to extract and summarize the quality of the
fit.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Use lpSolve to match fitted topics to true topics</span></span>
<span><span class="va">dist</span> <span class="op">=</span> <span class="fu"><a href="../reference/hellinger.html">hellinger</a></span><span class="op">(</span><span class="va">phi</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">beta_mx</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">soln</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/lpSolve/man/lp.assign.html" class="external-link">lp.assign</a></span><span class="op">(</span><span class="va">dist</span><span class="op">)</span></span>
<span><span class="va">soln</span><span class="op">$</span><span class="va">solution</span></span></code></pre></div>
<pre><code><span><span class="co">##       [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]</span></span>
<span><span class="co">##  [1,]    0    1    0    0    0    0    0    0    0     0</span></span>
<span><span class="co">##  [2,]    0    0    0    0    1    0    0    0    0     0</span></span>
<span><span class="co">##  [3,]    0    0    0    0    0    0    0    0    1     0</span></span>
<span><span class="co">##  [4,]    0    0    1    0    0    0    0    0    0     0</span></span>
<span><span class="co">##  [5,]    0    0    0    0    0    0    1    0    0     0</span></span>
<span><span class="co">##  [6,]    0    0    0    0    0    1    0    0    0     0</span></span>
<span><span class="co">##  [7,]    1    0    0    0    0    0    0    0    0     0</span></span>
<span><span class="co">##  [8,]    0    0    0    0    0    0    0    0    0     1</span></span>
<span><span class="co">##  [9,]    0    0    0    1    0    0    0    0    0     0</span></span>
<span><span class="co">## [10,]    0    0    0    0    0    0    0    1    0     0</span></span></code></pre>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/hellinger.html">hellinger</a></span><span class="op">(</span><span class="va">phi</span>, <span class="va">soln</span><span class="op">$</span><span class="va">solution</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">beta_mx</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            [,1]      [,2]      [,3]      [,4]      [,5]      [,6]      [,7]</span></span>
<span><span class="co">##  [1,] 0.1637336 0.8751537 0.8852931 0.9165058 0.9036184 0.8995845 0.9031738</span></span>
<span><span class="co">##  [2,] 0.8784121 0.1568935 0.8865806 0.9101200 0.8912032 0.9154690 0.9059649</span></span>
<span><span class="co">##  [3,] 0.8784830 0.8950844 0.1770633 0.9078316 0.8863298 0.8955629 0.9109254</span></span>
<span><span class="co">##  [4,] 0.9175881 0.9071975 0.9109467 0.1665250 0.9121768 0.8779525 0.9364565</span></span>
<span><span class="co">##  [5,] 0.9050252 0.8866189 0.8815338 0.9027020 0.1828639 0.9016970 0.8953244</span></span>
<span><span class="co">##  [6,] 0.9117772 0.9100060 0.8931672 0.8779031 0.9014234 0.1807501 0.9229747</span></span>
<span><span class="co">##  [7,] 0.9068759 0.9020294 0.9106445 0.9378145 0.8995111 0.9310713 0.1642187</span></span>
<span><span class="co">##  [8,] 0.8876726 0.9003917 0.9247945 0.9160216 0.8869320 0.9068250 0.9146167</span></span>
<span><span class="co">##  [9,] 0.9145803 0.8991201 0.8872700 0.9014559 0.8980827 0.9032983 0.8956926</span></span>
<span><span class="co">## [10,] 0.9152296 0.9000401 0.9255980 0.9052323 0.8837047 0.8869707 0.9112636</span></span>
<span><span class="co">##            [,8]      [,9]     [,10]</span></span>
<span><span class="co">##  [1,] 0.8929746 0.9123347 0.9223213</span></span>
<span><span class="co">##  [2,] 0.9026687 0.8988053 0.9044976</span></span>
<span><span class="co">##  [3,] 0.9222647 0.8766395 0.9139487</span></span>
<span><span class="co">##  [4,] 0.9142646 0.9072348 0.9077645</span></span>
<span><span class="co">##  [5,] 0.8907767 0.8977285 0.8797781</span></span>
<span><span class="co">##  [6,] 0.9064453 0.8931918 0.8961334</span></span>
<span><span class="co">##  [7,] 0.9160885 0.8921973 0.9032734</span></span>
<span><span class="co">##  [8,] 0.1708753 0.8977089 0.8796820</span></span>
<span><span class="co">##  [9,] 0.9004598 0.1682888 0.8968698</span></span>
<span><span class="co">## [10,] 0.8824513 0.8935218 0.1616073</span></span></code></pre>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/hellinger.html">hellinger</a></span><span class="op">(</span><span class="va">phi</span>, <span class="va">soln</span><span class="op">$</span><span class="va">solution</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">beta_mx</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">##  0.1569  0.1639  0.1674  0.1693  0.1755  0.1829</span></span></code></pre>
<p>And we do the same thing with the conventional topic model. It
performs somewhat better, with a median Hellinger distance of about
0.08. But again, it’s significantly slower.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">beta_stm_mx</span> <span class="op">=</span> <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">fitted_stm</span>, matrix <span class="op">=</span> <span class="st">'beta'</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="co">## Fix order of words</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>term <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">term</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">term</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="co">## And dropped words</span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/complete.html" class="external-link">complete</a></span><span class="op">(</span>term <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">vocab</span>, <span class="va">topic</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="st">'topic'</span>,</span>
<span>                values_from <span class="op">=</span> <span class="st">'beta'</span>, values_fill <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                names_sort <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="co"># select(-`NA`) |&gt;</span></span>
<span>    <span class="co">## Coerce to matrix</span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html" class="external-link">column_to_rownames</a></span><span class="op">(</span><span class="st">'term'</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/hellinger.html">hellinger</a></span><span class="op">(</span><span class="va">phi</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">beta_stm_mx</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                1          2          3          4          5          6</span></span>
<span><span class="co">##  [1,] 0.08551476 0.84250732 0.84248134 0.88213508 0.87444870 0.87157834</span></span>
<span><span class="co">##  [2,] 0.84329922 0.85367721 0.08226114 0.87003933 0.85853111 0.86964720</span></span>
<span><span class="co">##  [3,] 0.84814338 0.08498287 0.84966302 0.85873155 0.83485457 0.87730942</span></span>
<span><span class="co">##  [4,] 0.88728074 0.86458774 0.87596766 0.08716275 0.86137846 0.90341396</span></span>
<span><span class="co">##  [5,] 0.86509433 0.84154766 0.84198078 0.86693020 0.85183981 0.85492194</span></span>
<span><span class="co">##  [6,] 0.89275208 0.85457918 0.87148785 0.83690625 0.84770470 0.89097927</span></span>
<span><span class="co">##  [7,] 0.87604529 0.87475670 0.86935797 0.89497509 0.86136575 0.08427024</span></span>
<span><span class="co">##  [8,] 0.86179446 0.88513627 0.87104990 0.87765133 0.85763362 0.88206046</span></span>
<span><span class="co">##  [9,] 0.88272319 0.84014092 0.86831204 0.85799803 0.09038475 0.86010142</span></span>
<span><span class="co">## [10,] 0.88217135 0.87848592 0.86296463 0.86880249 0.85155013 0.87344130</span></span>
<span><span class="co">##                7          8          9         10</span></span>
<span><span class="co">##  [1,] 0.85051526 0.86539658 0.87856817 0.86805865</span></span>
<span><span class="co">##  [2,] 0.86158904 0.87025988 0.85982995 0.85353582</span></span>
<span><span class="co">##  [3,] 0.88224633 0.85827133 0.87289308 0.84502101</span></span>
<span><span class="co">##  [4,] 0.87295764 0.83661054 0.86684110 0.87271693</span></span>
<span><span class="co">##  [5,] 0.84603547 0.86047913 0.83835750 0.07902295</span></span>
<span><span class="co">##  [6,] 0.86282228 0.08880347 0.85411829 0.86252234</span></span>
<span><span class="co">##  [7,] 0.87474253 0.89536072 0.86677860 0.85727623</span></span>
<span><span class="co">##  [8,] 0.09267689 0.87054310 0.84452997 0.85300612</span></span>
<span><span class="co">##  [9,] 0.85178500 0.85313348 0.85250779 0.85785724</span></span>
<span><span class="co">## [10,] 0.84600884 0.85587004 0.09097089 0.84596278</span></span></code></pre>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rotation_stm</span> <span class="op">=</span> <span class="fu"><a href="../reference/hellinger.html">hellinger</a></span><span class="op">(</span><span class="va">phi</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">beta_stm_mx</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/lpSolve/man/lp.assign.html" class="external-link">lp.assign</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">magrittr</span><span class="fu">::</span><span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html" class="external-link">extract2</a></span><span class="op">(</span><span class="st">'solution'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/hellinger.html">hellinger</a></span><span class="op">(</span><span class="va">phi</span>, <span class="va">rotation_stm</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">beta_stm_mx</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">## 0.07902 0.08445 0.08634 0.08661 0.08999 0.09268</span></span></code></pre>
<p>The tidied word-topic distributions can be used in standard ways for
further analysis, such as a <a href="https://juliasilge.com/blog/2018/2018-01-25-sherlock-holmes-stm_files/figure-html/unnamed-chunk-6-1.png" class="external-link">Silge
plot</a> of the highest probability words for each topic. But because
the “words” in this simulation are just integers, and not semantically
meaningful, we don’t construct such a plot here.</p>
</div>
<div class="section level2">
<h2 id="topic-document-distributions">Topic-document distributions<a class="anchor" aria-label="anchor" href="#topic-document-distributions"></a>
</h2>
<p>We extract topic-document distributions using the same
<code><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy()</a></code> function, specifying the matrix <code>gamma</code>
and including the rotation above to align the fitted and true topics.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;As with the word-topic distributions/loadings above, the
scores must be transformed to treat them as topic-document
distributions. Experiments with this simulation found that nudging the
scores — setting the smallest score in each document to zero — and then
dividing by the total was the most effective approach. Note that this
means that each document has probability exactly zero for one topic.&lt;/p&gt;"><sup>4</sup></a> Tile and
parallel coordinates plots can be used to visualize all of the
topic-document distributions. These show that the varimax topic models
successfully recover the overall association of each document’s journal
with a distinctive topic.</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gamma_df</span> <span class="op">=</span> <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">fitted</span>, <span class="va">k</span>, <span class="st">'gamma'</span>, </span>
<span>                rotation <span class="op">=</span> <span class="va">soln</span><span class="op">$</span><span class="va">solution</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in tidy.tmfast(fitted, k, "gamma", rotation = soln$solution): Rotating</span></span>
<span><span class="co">## scores</span></span></code></pre>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gamma_df</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>document <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">document</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">document</span>, <span class="va">topic</span>, fill <span class="op">=</span> <span class="va">gamma</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulated_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gamma_df</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>document <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">document</span><span class="op">)</span>,</span>
<span>           journal <span class="op">=</span> <span class="op">(</span><span class="va">document</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%/%</a></span> <span class="va">Mj</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">topic</span>, <span class="va">gamma</span>, </span>
<span>               group <span class="op">=</span> <span class="va">document</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">journal</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">.25</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">journal</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">'free_x'</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_discrete.html" class="external-link">scale_color_discrete</a></span><span class="op">(</span>guide <span class="op">=</span> <span class="st">'none'</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulated_files/figure-html/unnamed-chunk-19-2.png" width="700"></p>
<p>However, the fitted topic-document distributions are flatter than the
true ones. Consider the true and fitted distributions for document 1.
Compared to the true distribution, the fitted distribution has a
somewhat lower probability for topic <code>V01</code> and a somewhat
higher probability for the other topics.</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">topic</span>, group <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">theta</span>, color <span class="op">=</span> <span class="st">'true'</span><span class="op">)</span>, </span>
<span>              data <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="va">theta</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span>, </span>
<span>                            topic <span class="op">=</span> <span class="fu">tmfast</span><span class="fu">:::</span><span class="fu"><a href="../reference/make_colnames.html">make_colnames</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">k</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">gamma</span>, color <span class="op">=</span> <span class="st">'fitted'</span><span class="op">)</span>, </span>
<span>              data <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">gamma_df</span>, <span class="va">document</span> <span class="op">==</span> <span class="st">'1'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulated_files/figure-html/unnamed-chunk-20-1.png" width="700"></p>
<p>This flatter distribution corresponds to greater entropy. In this
simulation, the entropy of the fitted distributions are about 1 bit
greater than those of the true distributions. This discrepancy tends to
become worse with greater values of <span class="math inline">\(k\)</span>.</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">theta</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">entropy</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">##  0.1006  0.6614  0.9715  1.0100  1.3311  2.5821</span></span></code></pre>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">fitted</span>, <span class="va">k</span>, <span class="st">'gamma'</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">document</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>H <span class="op">=</span> <span class="fu"><a href="../reference/entropy.html">entropy</a></span><span class="op">(</span><span class="va">gamma</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">H</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">##  0.8486  1.7040  1.9319  1.9129  2.1592  2.7673</span></span></code></pre>
<p>To mitigate this problem, we add an optional renormalization step
when converting document scores to topic-document distributions. Given a
discrete probability distribution <span class="math inline">\(P\)</span>
with components <span class="math inline">\(p_i\)</span> and entropy
<span class="math inline">\(H\)</span>, and a parameter <span class="math inline">\(\beta\)</span>, we can define a new distribution
<span class="math inline">\(P'\)</span> with components</p>
<p><span class="math display">\[ p'_i = \frac{p_i^\beta}{\sum_i
p_i^\beta} = \frac{p_i^\beta}{Z}\]</span></p>
<p>which has entropy</p>
<p><span class="math display">\[ H' = \frac{1}{Z} \sum_i [p_i^\beta
\beta \log p_i] - \log Z.\]</span></p>
<p>That is, we can choose a parameter <span class="math inline">\(\beta\)</span> that renormalizes <span class="math inline">\(P\)</span> to achieve a target entropy <span class="math inline">\(H'\)</span>. In LDA, the target entropy is the
expected entropy for topic-document distributions drawn from the
Dirichlet prior. <code>tmfast</code> provides convenience functions for
calculating this expected entropy; compare this to the mean entropy of
the distributions in <code>theta</code> above. <strong>In actual
applications, where the Dirichlet prior is an idealization, choosing
<span class="math inline">\(\alpha\)</span> to set the target entropy is
an important researcher degree of freedom.</strong> It is equivalent to
choosing prior parameters in other topic modeling packages.</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/peak_alpha.html">peak_alpha</a></span><span class="op">(</span><span class="va">k</span>, <span class="fl">1</span>, <span class="va">topic_peak</span>, <span class="va">topic_scale</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] 8.0000000 0.2222222 0.2222222 0.2222222 0.2222222 0.2222222 0.2222222</span></span>
<span><span class="co">##  [8] 0.2222222 0.2222222 0.2222222</span></span></code></pre>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/expected_entropy.html">expected_entropy</a></span><span class="op">(</span><span class="fu"><a href="../reference/peak_alpha.html">peak_alpha</a></span><span class="op">(</span><span class="va">k</span>, <span class="fl">1</span>, <span class="va">topic_peak</span>, <span class="va">topic_scale</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.997604</span></span></code></pre>
<p>Since solving the equation for <span class="math inline">\(H'\)</span> for <span class="math inline">\(\beta\)</span> requires numerical optimization,
it’s inefficient to do this every time we call <code><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy()</a></code>,
especially with large corpora. Instead,
<code><a href="../reference/target_power.html">tmfast::target_power()</a></code> is used to run this optimization
once, and then return the mean value across all documents. We then use
this single value of <span class="math inline">\(\beta\)</span> in all
future calls to <code><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy()</a></code>.</p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gamma_power</span> <span class="op">=</span> <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">fitted</span>, <span class="va">k</span>, <span class="st">'gamma'</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="../reference/target_power.html">target_power</a></span><span class="op">(</span><span class="va">document</span>, <span class="va">gamma</span>, </span>
<span>                 <span class="fu"><a href="../reference/expected_entropy.html">expected_entropy</a></span><span class="op">(</span><span class="fu"><a href="../reference/peak_alpha.html">peak_alpha</a></span><span class="op">(</span><span class="va">k</span>, </span>
<span>                                             <span class="fl">1</span>, </span>
<span>                                             <span class="va">topic_peak</span>, </span>
<span>                                             <span class="va">topic_scale</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">gamma_power</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1.539377</span></span></code></pre>
<p>The renormalized topic-document distributions have closer entropy to
theta. The <code>keep_original</code> argument lets us compare the
original and renormalized distributions.</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gamma_df</span> <span class="op">=</span> <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">fitted</span>, <span class="va">k</span>, <span class="st">'gamma'</span>, </span>
<span>                rotation <span class="op">=</span> <span class="va">soln</span><span class="op">$</span><span class="va">solution</span>, </span>
<span>                exponent <span class="op">=</span> <span class="va">gamma_power</span>, </span>
<span>                keep_original <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in tidy.tmfast(fitted, k, "gamma", rotation = soln$solution, exponent =</span></span>
<span><span class="co">## gamma_power, : Rotating scores</span></span></code></pre>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gamma_df</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">document</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">gamma</span>, <span class="va">gamma_rn</span><span class="op">)</span>, <span class="va">entropy</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">gamma</span>, <span class="va">gamma_rn</span><span class="op">)</span>, <span class="va">mean</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 1 × 2</span></span></span>
<span><span class="co">##   gamma gamma_rn</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>  1.91     1.03</span></span></code></pre>
<p>We can now assess accuracy of the topic-document distributions. Above
we used the <code><a href="../reference/hellinger.html">hellinger()</a></code> method for two matrices. The method
for two dataframes requires specifying the id, topic, and probability
columns. The tile plot shows that the true and fitted topics are aligned
(because we used the rotation when extracting <code>gamma_df</code>
above), and so again we can get an overall summary from the diagonal.
Without renormalization, in the current simulation the mean Hellinger
distance is 0.24 — not too bad, but perhaps larger than one would like.
With larger values of <span class="math inline">\(k\)</span>, this
accuracy increases significantly. Renormalization keeps the mean
distance around 0.13, slightly better the the word-topic
distributions.</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## w/o renormalization, mean distance is .24</span></span>
<span><span class="fu"><a href="../reference/hellinger.html">hellinger</a></span><span class="op">(</span><span class="va">theta_df</span>, <span class="va">doc</span>,</span>
<span>                        topicsdf2 <span class="op">=</span> <span class="va">gamma_df</span>, id2 <span class="op">=</span> <span class="va">document</span>, </span>
<span>                        prob2 <span class="op">=</span> <span class="va">gamma</span>, df <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">## 0.08499 0.20131 0.23733 0.23770 0.27244 0.37585</span></span></code></pre>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## w/ renormalization, mean distance drops to .13</span></span>
<span><span class="va">doc_compare</span> <span class="op">=</span> <span class="fu"><a href="../reference/hellinger.html">hellinger</a></span><span class="op">(</span><span class="va">theta_df</span>, <span class="va">doc</span>,</span>
<span>          topicsdf2 <span class="op">=</span> <span class="va">gamma_df</span>, id2 <span class="op">=</span> <span class="va">document</span>, </span>
<span>          prob2 <span class="op">=</span> <span class="va">gamma_rn</span>, df <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">doc_compare</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">doc</span> <span class="op">==</span> <span class="va">document</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">dist</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">## 0.04808 0.10195 0.12378 0.12518 0.14564 0.24868</span></span></code></pre>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">doc_compare</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">doc</span><span class="op">)</span>, </span>
<span>                        <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">document</span><span class="op">)</span>, </span>
<span>                        fill <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">dist</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html" class="external-link">scale_x_discrete</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="cn">NULL</span>, name <span class="op">=</span> <span class="st">'true'</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html" class="external-link">scale_y_discrete</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="cn">NULL</span>, name <span class="op">=</span> <span class="st">'fitted'</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulated_files/figure-html/unnamed-chunk-25-1.png" width="700"></p>
<p>STM has a slightly closer fit, with a mean Hellinger distance of
0.08.</p>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fitted_stm_gamma</span> <span class="op">=</span> <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">fitted_stm</span>, matrix <span class="op">=</span> <span class="st">'gamma'</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="st">'topic'</span>, </span>
<span>                values_from <span class="op">=</span> <span class="st">'gamma'</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html" class="external-link">column_to_rownames</a></span><span class="op">(</span><span class="st">'document'</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/hellinger.html">hellinger</a></span><span class="op">(</span><span class="va">theta</span>, <span class="va">fitted_stm_gamma</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">rotation_stm</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">## 0.03216 0.07148 0.08638 0.08823 0.10260 0.19884</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="discursive-space-visualization-using-t-sne-and-umap">Discursive space visualization using t-SNE and UMAP<a class="anchor" aria-label="anchor" href="#discursive-space-visualization-using-t-sne-and-umap"></a>
</h2>
<p>Hicks (2021) proposed using topic models and Hellinger distance to
analyze the relative position of documents in “discursive space.” That
paper used the t-SNE dimension-reduction algorithm to produce a 2D
visualization of Hellinger distances. The UMAP algorithm is also
popular, and is <a href="https://pair-code.github.io/understanding-umap/" class="external-link">believed</a> to
do better than t-SNE at preserving global structure. <code>tmfast</code>
provides functions <code><a href="../reference/tsne.html">tsne()</a></code> and <code><a href="../reference/umap.html">umap()</a></code> to
efficiently produce such visualizations. Note that the t-SNE algorithm
involves further random number draws (I believe to set the initial
positions of the points), so repeatedly running this next chunk will
produce superficially different visualizations.</p>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/tsne.html">tsne</a></span><span class="op">(</span><span class="va">fitted</span>, <span class="va">k</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>journal <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">document</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%/%</a></span> <span class="va">Mj</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">journal</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">'t-SNE visualization'</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulated_files/figure-html/unnamed-chunk-27-1.png" width="700"></p>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/umap.html">umap</a></span><span class="op">(</span><span class="va">fitted</span>, <span class="va">k</span>, df <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>journal <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">document</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%/%</a></span> <span class="va">Mj</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">journal</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">'UMAP visualization'</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulated_files/figure-html/unnamed-chunk-27-2.png" width="700"></p>
</div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Dan Hicks.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
